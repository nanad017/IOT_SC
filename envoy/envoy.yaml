# 1. ------------------
# Admin UI để debug Envoy
# ------------------
admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901

# 2. ------------------
# Listeners & Clusters
# ------------------
static_resources:
  listeners:
  - name: listener_https
    address:
      socket_address: 
        address: 0.0.0.0
        port_value: 8443   # Envoy HTTPS

    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          access_log:
            - name: envoy.access_loggers.stdout
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                log_format:
                  text_format: |
                    [%START_TIME%]
                    method=%REQ(:METHOD)%
                    path=%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%
                    status=%RESPONSE_CODE%
                    details=%RESPONSE_CODE_DETAILS%
                    jwt_error=%DYNAMIC_METADATA(envoy.filters.http.jwt_authn:error)%
                    request_id=%REQ(X-REQUEST-ID)%
          # ============================================================
          # HTTP FILTERS (đã sửa đúng thứ tự)
          # ============================================================
          http_filters:

          # ------------------------------------------------------------
          # 1) JWT AUTHENTICATION (phải chạy TRƯỚC OPA)
          # ------------------------------------------------------------
          - name: envoy.filters.http.jwt_authn
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
              providers:
                keycloak_provider:
                  issuer: http://localhost:8080/realms/IOT_SC   # <-- đúng realm
                  audiences:
                    - account

                  remote_jwks:
                    http_uri:
                      uri: http://localhost:8080/realms/IOT_SC/protocol/openid-connect/certs   # <-- sửa đúng JWKS
                      cluster: keycloak_service
                      timeout: 1s

              # Chỉ bắt JWT trên đường dẫn /api/user/*
              rules:
                - match: { prefix: "/api/user" }
                  requires:
                    provider_name: keycloak_provider


          # ------------------------------------------------------------
          # 2) OPA AUTHORIZATION (chạy SAU khi JWT OK)
          # ------------------------------------------------------------
          # - name: envoy.filters.http.ext_authz 
          #   typed_config:
          #     "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
          #     transport_api_version: V3
          #     with_request_body:
          #       max_request_bytes: 8192
          #       allow_partial_message: true

          #     failure_mode_allow: false   # OPA chết → CHẶN
          #     grpc_service:
          #       envoy_grpc:
          #         cluster_name: opa_service
          #       timeout: 0.5s
          - name: envoy.filters.http.ext_authz
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
              transport_api_version: V3

              failure_mode_allow: false           # ✅ [GIỮ]

              http_service:                       # ✅ [THÊM]
                server_uri:                       # ✅ [THÊM]
                  uri: http://opa:8181            # ✅ [THÊM]
                  cluster: opa_service            # ✅ [THÊM]
                  timeout: 0.5s                   # ✅ [THÊM]

                path_prefix: /v1/data/envoy/authz # ✅ [THÊM]

                authorization_request:            # ✅ [THÊM]
                  allowed_headers:                # ✅ [THÊM]
                    patterns:
                      - exact: authorization      # ✅ [THÊM]
                      - exact: path               # ✅ [THÊM]
                      - exact: method             # ✅ [THÊM]


          # ------------------------------------------------------------
          # 3) ROUTER (luôn để cuối)
          # ------------------------------------------------------------
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router


          # ============================================================
          # ROUTING
          # ============================================================
          route_config:
            name: local_route
            virtual_hosts:
            - name: backend
              domains: ["*"]
              routes:
              - match: { prefix: "/" }
                route:
                  cluster: web_service    # chuyển đến Flask (web)


      # -----------------------------------------------------------
      # TLS / mTLS CONFIG
      # -----------------------------------------------------------
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext

          common_tls_context:
            tls_certificates:
              - certificate_chain:
                  filename: "/etc/envoy/certs/envoy-proxy.crt"
                private_key:
                  filename: "/etc/envoy/certs/envoy-proxy.key"

            validation_context:
              trusted_ca:
                filename: "/etc/envoy/certs/rootCA.crt"

          # mTLS bật/tắt tại đây
          require_client_certificate: false   # sếp đang test → giữ nguyên


  # 3. ------------------
  # CLUSTERS
  # ------------------
  clusters:

  # Flask Web Backend
  - name: web_service
    connect_timeout: 0.25s
    type: logical_dns
    dns_lookup_family: V4_ONLY
    load_assignment:
      cluster_name: web_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address: 
                address: web
                port_value: 5000

  # OPA Cluster (gRPC)
  - name: opa_service
    connect_timeout: 0.25s
    type: logical_dns
    dns_lookup_family: V4_ONLY
    # http2_protocol_options: {}       # bắt buộc vì OPA dùng gRPC ext_authz
    load_assignment:
      cluster_name: opa_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: opa
                port_value: 8181    # đúng port của OPA


  # Keycloak Cluster
  - name: keycloak_service
    connect_timeout: 1s
    type: logical_dns
    dns_lookup_family: V4_ONLY
    load_assignment:
      cluster_name: keycloak_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: keycloak
                port_value: 8080
